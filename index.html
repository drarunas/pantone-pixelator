<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pantone Pixelator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #canvas-container {
      max-width: 100%;
      overflow-x: auto;
    }
    canvas {
      height: auto;
      max-width: 100%;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans p-8">
  <h1 class="text-2xl font-bold mb-2 text-center">Pantone Pixelator</h1>
  <div class="flex flex-col items-center space-y-4">
    <input type="file" id="upload" accept="image/*" class="file:mr-4 file:py-2 file:px-4 file:border-0 file:rounded-full file:bg-indigo-600 file:text-white hover:file:bg-indigo-700">

    <div class="grid grid-cols-4 md:grid-cols-3 gap-4">
      <label class="flex flex-col items-start text-sm">
        Columns
        <input type="number" id="numColumns" value="20" min="1" max="100" class="rounded border px-2 py-1">
      </label>
      <label class="flex flex-col items-start text-sm">
        Scale
        <input type="number" id="scale" value="2" min="1" max="10" class="rounded border px-2 py-1">
      </label>
      <label class="flex flex-col items-start text-sm">
        Font Size
        <input type="number" id="fontSize" value="8" min="1" max="30" class="rounded border px-2 py-1">
      </label>
      <label class="flex flex-col items-start text-sm">
        Font Color
        <input type="color" id="fontColor" value="#000000" class="rounded border px-2 py-1 h-10 w-full">
      </label>
      <label class="flex flex-col items-start text-sm">
        Font Family
        <select id="fontFamily" class="rounded border px-2 py-1">
          <option value="sans-serif">Sans Serif</option>
          <option value="serif">Serif</option>
          <option value="monospace">Monospace</option>
          <option value="Arial">Arial</option>
          <option value="Courier New">Courier New</option>
          <option value="Georgia">Georgia</option>
        </select>
      </label>
      <label class="flex flex-col items-start text-sm">
        Vertical Spacing
        <input type="number" id="vSpacing" value="2" min="0" max="20" class="rounded border px-2 py-1">
      </label>
      <label class="flex flex-col items-start text-sm">
        Horizontal Spacing
        <input type="number" id="hSpacing" value="6" min="0" max="20" class="rounded border px-2 py-1">
      </label>
      <label class="flex flex-col items-start text-sm">
        Background Color
        <input type="color" id="bgColor" value="#ffffff" class="rounded border px-2 py-1 h-10 w-full">
      </label>
    </div>

    <button id="download" disabled class="bg-green-600 text-white px-4 py-2 rounded disabled:opacity-50">Download Output</button>
    <div id="canvas-container" class="w-full overflow-auto border mt-4">
      <canvas id="canvas"></canvas>
    </div>
  </div>

  <script type="module">
    const upload = document.getElementById('upload');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const downloadBtn = document.getElementById('download');

    const numColumnsInput = document.getElementById('numColumns');
    const scaleInput = document.getElementById('scale');
    const fontSizeInput = document.getElementById('fontSize');
    const fontColorInput = document.getElementById('fontColor');
    const fontFamilyInput = document.getElementById('fontFamily');
    const vSpacingInput = document.getElementById('vSpacing');
    const hSpacingInput = document.getElementById('hSpacing');
    const bgColorInput = document.getElementById('bgColor');

    let pantoneColors;
    let uploadedImg = null;

    function rgbToLab([r, g, b]) {
      [r, g, b] = [r, g, b].map(v => {
        v /= 255;
        return v > 0.04045 ? Math.pow((v + 0.055) / 1.055, 2.4) : v / 12.92;
      });
      const x = (r * 0.4124 + g * 0.3576 + b * 0.1805) / 0.95047;
      const y = (r * 0.2126 + g * 0.7152 + b * 0.0722);
      const z = (r * 0.0193 + g * 0.1192 + b * 0.9505) / 1.08883;

      const f = t => t > 0.008856 ? Math.cbrt(t) : (7.787 * t) + (16 / 116);
      return [
        116 * f(y) - 16,
        500 * (f(x) - f(y)),
        200 * (f(y) - f(z))
      ];
    }

    fetch('pantone_colors_rgb.json')
      .then(res => res.json())
      .then(data => {
        pantoneColors = Object.entries(data).map(([name, rgb]) => {
          const lab = rgbToLab(rgb);
          return { name, rgb, lab };
        });
      });

    upload.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file || !pantoneColors) return;

      const img = new Image();
      img.src = URL.createObjectURL(file);
      await img.decode();

      uploadedImg = img;
      renderImage();
    });

    async function renderImage() {
      if (!uploadedImg || !pantoneColors) return;

      const img = uploadedImg;
      const scale = parseInt(scaleInput.value);
      const numColumns = parseInt(numColumnsInput.value);
      const fontSize = parseInt(fontSizeInput.value);
      const fontColor = fontColorInput.value;
      const fontFamily = fontFamilyInput.value;
      const vSpacing = parseInt(vSpacingInput.value) * scale;
      const hSpacing = parseInt(hSpacingInput.value) * scale;
      const labelHeight = fontSize * 1.25;
      const bgColor = bgColorInput.value;

      const aspect = img.width / img.height;
      const blockSize = Math.floor((img.width - (numColumns - 1) * hSpacing) / numColumns);
      const swatchW = blockSize + hSpacing;
      const swatchH = blockSize + labelHeight + vSpacing;
      const numRows = Math.round(numColumns / aspect * (swatchW / swatchH));

      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = numColumns;
      tempCanvas.height = numRows;
      const tempCtx = tempCanvas.getContext('2d');
      tempCtx.drawImage(img, 0, 0, numColumns, numRows);
      const imgData = tempCtx.getImageData(0, 0, numColumns, numRows).data;

      const outW = numColumns * swatchW - hSpacing;
      const outH = numRows * swatchH - vSpacing;

      const pixelRatio = window.devicePixelRatio || 2;
      canvas.width = (outW + 50) * pixelRatio;
      canvas.height = (outH + 50) * pixelRatio;
      
      ctx.setTransform(pixelRatio, 0, 0, pixelRatio, 0, 0);

      ctx.fillStyle = bgColor;
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      ctx.font = `${fontSize}px ${fontFamily}`;
      ctx.textAlign = "center";
      ctx.fillStyle = fontColor;

      for (let y = 0; y < numRows; y++) {
        for (let x = 0; x < numColumns; x++) {
          const idx = (y * numColumns + x) * 4;
          const rgb = [imgData[idx], imgData[idx + 1], imgData[idx + 2]];

          const lab = rgbToLab(rgb);
          let closest = pantoneColors[0];
          let minDist = Infinity;
          for (const pantone of pantoneColors) {
            const d = Math.hypot(
              lab[0] - pantone.lab[0],
              lab[1] - pantone.lab[1],
              lab[2] - pantone.lab[2]
            );
            if (d < minDist) {
              minDist = d;
              closest = pantone;
            }
          }

          const x0 = x * swatchW + 25;
          const y0 = y * swatchH + 25;
          ctx.fillStyle = `rgb(${closest.rgb.join(",")})`;
          ctx.fillRect(x0, y0, blockSize, blockSize);

          const name = closest.name.slice(0, 20);
          ctx.fillStyle = fontColor;
          ctx.fillText(name, x0 + blockSize / 2, y0 + blockSize + labelHeight);
        }
      }

      downloadBtn.disabled = false;
    }

    [numColumnsInput, scaleInput, fontSizeInput, fontColorInput, fontFamilyInput, vSpacingInput, hSpacingInput, bgColorInput].forEach(input => {
      input.addEventListener('input', () => {
        if (uploadedImg) renderImage();
      });
    });

    downloadBtn.addEventListener('click', () => {
      const link = document.createElement('a');
      link.download = 'pantone_output.png';
      link.href = canvas.toDataURL();
      link.click();
    });
  </script>
</body>
</html>
